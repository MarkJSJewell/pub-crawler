<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pub Crawl Planner</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üç∫</text></svg>">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Google Sans', 'Roboto', Arial, sans-serif; background: #f8f9fa; min-height: 100vh; color: #202124; padding-top: 80px; }
        
        /* Header */
        .header { position: fixed; top: 0; left: 0; right: 0; background: #fff; padding: 16px 24px; border-bottom: 1px solid #dadce0; display: flex; align-items: center; justify-content: space-between; z-index: 1000; }
        .header-left { display: flex; align-items: center; gap: 16px; }
        .app-title { font-size: 18px; color: #5f6368; font-weight: 400; }
        .header-right { display: flex; align-items: center; gap: 20px; }
        .user-controls { display: flex; align-items: center; gap: 12px; border-left: 1px solid #dadce0; padding-left: 20px; }

        .main-container { max-width: 1000px; margin: 0 auto; padding: 20px; }

        /* Search Form */
        .search-wrapper { background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(60,64,67,.15); overflow: hidden; margin-bottom: 20px; transition: all 0.3s ease; }
        .search-form { padding: 24px; }
        .search-wrapper.collapsed .search-form { display: none; }
        .search-header { display: none; padding: 16px 24px; background: #f1f3f4; justify-content: space-between; align-items: center; cursor: pointer; border-bottom: 1px solid #dadce0; }
        .search-wrapper.collapsed .search-header { display: flex; }
        
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 500; color: #3c4043; font-size: 13px; }
        .form-group input, .form-group select { width: 100%; padding: 10px 12px; border: 1px solid #dadce0; border-radius: 4px; font-size: 14px; background: white; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .search-btn { background: #1a73e8; color: white; border: none; padding: 12px; font-size: 14px; font-weight: 500; border-radius: 4px; cursor: pointer; width: 100%; }

        /* Map & Results */
        #map-container { height: 400px; width: 100%; background: #e8eaed; border-radius: 8px; margin-bottom: 20px; display: none; border: 1px solid #dadce0; }
        #map { height: 100%; width: 100%; }
        .results-section { display: none; }
        .route-summary { background: white; padding: 16px; border-radius: 8px; border: 1px solid #dadce0; margin-bottom: 20px; position: relative; }
        .cache-badge { position: absolute; top: 16px; right: 16px; font-size: 11px; color: #1a73e8; background: #e8f0fe; padding: 2px 8px; border-radius: 4px; }

        .pub-card { background: white; border: 1px solid #dadce0; border-radius: 8px; padding: 16px; margin-bottom: 16px; display: grid; grid-template-columns: 1fr 300px; gap: 20px; cursor: pointer; }
        @media (max-width: 768px) { .pub-card { grid-template-columns: 1fr; } }

        .pub-info h3 { color: #1a73e8; font-size: 16px; font-weight: 500; margin-bottom: 4px; }
        .pub-address { color: #5f6368; font-size: 13px; margin-bottom: 8px; }
        .pub-badges { display: flex; flex-wrap: wrap; gap: 6px; margin: 8px 0; }
        .badge { padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 500; }
        .badge-priority { background: #fef7e0; color: #b06000; }
        .badge-sports { background: #e6f4ea; color: #137333; }
        .badge-outdoor { background: #e8f0fe; color: #1967d2; }
        .badge-dogfriendly { background: #f3e8ff; color: #7e22ce; }
        
        .ai-summary-box { background: #f8f9fa; border-left: 3px solid #1a73e8; padding: 12px; border-radius: 4px; font-size: 13px; line-height: 1.5; }
        .route-leg-info { margin-top: 12px; padding-top: 10px; border-top: 1px dashed #e8eaed; font-size: 13px; color: #1a73e8; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; }
        .modal-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 12px; max-width: 600px; width: 95%; max-height: 85vh; overflow-y: auto; }
        .modal-header { padding: 20px; border-bottom: 1px solid #e8eaed; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: white; }
        .modal-body { padding: 20px; }
        .review-card { background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 12px; border: 1px solid #e8eaed; }
    </style>
</head>
<body>

    <div class="header">
        <div class="header-left">
            <span style="font-size: 22px; margin-right: 8px;">üç∫</span>
            <div class="app-title">Pub Crawl Planner</div>
        </div>
        
        <div class="header-right">
            <div id="api-status" style="font-size: 13px; color: #5f6368;">Connecting...</div>
            <div class="user-controls">
                <span id="user-email" style="font-size: 13px; color: #5f6368; font-weight: 500;"></span>
                <button onclick="signOut()" style="background: white; border: 1px solid #dadce0; padding: 6px 12px; border-radius: 4px; cursor: pointer; color: #1a73e8; font-weight: 500;">Sign Out</button>
            </div>
        </div>
    </div>

    <div class="main-container">
        <div class="search-wrapper" id="search-wrapper">
            <div class="search-header" onclick="toggleSearch()">
                <div><strong>üîç Route:</strong> <span id="summary-text" style="font-size: 14px; color: #5f6368;">Plan your crawl</span></div>
                <button style="background:none; border:none; color:#1a73e8; font-weight:500; cursor:pointer;">Edit Search</button>
            </div>
            <div class="search-form">
                <form id="search-form">
                    <div class="form-group">
                        <label>Start Location</label>
                        <input type="text" name="location" id="location-input" placeholder="e.g. Covent Garden" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Stops</label>
                            <select name="num-pubs">
                                <option value="3">3 stops</option>
                                <option value="5" selected>5 stops</option>
                                <option value="8">8 stops</option>
                                <option value="10">10 stops</option>
                                <option value="15">15 stops</option>
                                <option value="20">20 stops</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Vibe</label>
                            <select name="historic-filter">
                                <option value="all">All Pubs</option>
                                <option value="priority">üèõÔ∏è Historic / Traditional</option>
                                <option value="brewery">üç∫ Brewery / Taproom</option>
                                <option value="outdoor">üå≥ Outdoor / Garden</option>
                                <option value="sports">‚öΩ Sports Bar</option>
                                <option value="dogfriendly">üêï Dog Friendly</option>
                                <option value="afternoontea">ü´ñ Afternoon Tea</option>
                                <option value="happyhour">üçª Happy Hour</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Max Walk</label>
                            <select name="max-distance">
                                <option value="2000">2 km (Easy)</option>
                                <option value="5000" selected>5 km (Medium)</option>
                                <option value="10000">10 km (Long)</option>
                                <option value="15000">15 km</option>
                                <option value="20000">20 km</option>
                                <option value="50000">50 km</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Start Radius</label>
                            <select name="starting-radius">
                                <option value="500">0.5 km</option>
                                <option value="1000" selected>1 km</option>
                                <option value="2000">2 km</option>
                                <option value="5000">5 km</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Min Rating</label>
                            <select name="min-rating">
                                <option value="3.5">3.5+</option>
                                <option value="4.0" selected>4.0+</option>
                                <option value="4.5">4.5+</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Opening</label>
                            <select name="open-now">
                                <option value="false">Any time</option>
                                <option value="true">Open Now</option>
                            </select>
                        </div>
                    </div>
                    
                    <button type="submit" class="search-btn">Find Route</button>
                </form>
            </div>
        </div>

        <div class="results-section" id="results-section">
            <div id="map-container"><div id="map"></div></div>
            <div class="route-summary" id="route-summary"></div>
            <div id="pub-list"></div>
        </div>
    </div>

    <div class="modal" id="pub-modal"><div class="modal-content"><div class="modal-header"><h3 id="modal-title"></h3><span class="close" id="modal-close">√ó</span></div><div class="modal-body" id="modal-body"></div></div></div>

    <script>
        let map, directionsService, directionsRenderer, placesService, currentCenter;
        let currentPubs = [];
        let currentRouteData = null;

        function initializeGoogleMaps() {
            map = new google.maps.Map(document.getElementById('map'), { zoom: 13, center: { lat: 51.5, lng: -0.1 }, mapTypeControl: false });
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({ map: map, suppressMarkers: false });
            placesService = new google.maps.places.PlacesService(map);
        }

        function initializeAutocomplete() {
            new google.maps.places.Autocomplete(document.getElementById('location-input'), { types: ['geocode', 'establishment'] });
        }

        function toggleSearch() { 
            const wrapper = document.getElementById('search-wrapper');
            wrapper.classList.toggle('collapsed');
        }

        async function searchPubs(location, numPubs, historicFilter, maxDistance, minRating, openNow, startingRadius) {
            document.getElementById('results-section').style.display = 'none';
            document.getElementById('map-container').style.display = 'block';
            
            try {
                const cacheKey = `pubs_${btoa(location + historicFilter)}`;
                const cached = localStorage.getItem(cacheKey);
                let center, pubs, isFromCache = false;

                if (cached) {
                    const parsed = JSON.parse(cached);
                    if (Date.now() - parsed.timestamp < 86400000) {
                        center = parsed.center;
                        pubs = parsed.pubs.map(p => ({
                            ...p, 
                            geometry: { location: new google.maps.LatLng(p.geometry.location.lat, p.geometry.location.lng) }
                        }));
                        isFromCache = true;
                    }
                }

                if (!isFromCache) {
                    center = await geocodeLocation(location);
                    pubs = await findPubs(center, 2000, historicFilter);
                    localStorage.setItem(cacheKey, JSON.stringify({ center, pubs, timestamp: Date.now() }));
                }

                currentCenter = center;
                const directions = await calculateDirections(pubs.slice(0, numPubs));
                currentRouteData = directions;
                currentPubs = pubs.slice(0, numPubs);

                document.getElementById('summary-text').textContent = `${currentPubs.length} pubs near ${location}`;
                document.getElementById('search-wrapper').classList.add('collapsed');
                document.getElementById('results-section').style.display = 'block';
                
                displayResults(currentPubs, isFromCache);
            } catch (e) { alert(e.message); }
        }

        async function geocodeLocation(address) {
            const user = firebase.auth().currentUser;
            const token = await user.getIdToken();
            const res = await fetch('https://pub-crawler-backend.vercel.app/api/geocode', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ address })
            });
            const data = await res.json();
            return data.results[0].geometry.location;
        }

        async function findPubs(center, radius, filter) {
            const user = firebase.auth().currentUser;
            const token = await user.getIdToken();
            let keyword = 'pub';
            if (filter === 'outdoor') keyword = 'pub with beer garden OR terrace OR pavement seating';
            if (filter === 'brewery') keyword = 'brewery OR microbrewery OR taproom';
            
            const res = await fetch('https://pub-crawler-backend.vercel.app/api/search-places', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ location: `${center.lat},${center.lng}`, radius, keyword })
            });
            const data = await res.json();
            return data.places.map(p => ({
                place_id: p.id, 
                name: p.displayName.text, 
                vicinity: p.formattedAddress, 
                rating: p.rating, 
                user_ratings_total: p.userRatingCount,
                goodForWatchingSports: p.goodForWatchingSports || false,
                outdoorSeating: p.outdoorSeating || false,
                allowsDogs: p.allowsDogs || false,
                geometry: { location: new google.maps.LatLng(p.location.latitude, p.location.longitude) },
                editorial_summary: p.editorialSummary?.text
            }));
        }

        function calculateDirections(pubs) {
            return new Promise(resolve => {
                const waypoints = pubs.slice(1, -1).map(p => ({ location: p.geometry.location, stopover: true }));
                directionsService.route({
                    origin: pubs[0].geometry.location, destination: pubs[pubs.length-1].geometry.location,
                    waypoints, travelMode: 'WALKING'
                }, (result) => resolve(result));
            });
        }

        function displayResults(pubs, isFromCache) {
            directionsRenderer.setDirections(currentRouteData);
            
            // [RESTORED] Add Blue Pin for Starting Location
            new google.maps.Marker({
                position: currentCenter, map: map,
                icon: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png',
                title: 'Search Origin'
            });

            displaySummary(pubs, isFromCache);
            displayPubList(pubs);
        }

        function displaySummary(pubs, isFromCache) {
            const summary = document.getElementById('route-summary');
            const totalDist = currentRouteData.routes[0].legs.reduce((acc, leg) => acc + leg.distance.value, 0);
            const km = (totalDist / 1000).toFixed(1);
            
            summary.innerHTML = `
                <div class="cache-badge">${isFromCache ? '‚úì Local Storage' : '‚ö° Fresh Results'}</div>
                <h3>Route Overview</h3>
                <p><strong>${pubs.length} Stops</strong> ‚Ä¢ ${km} km total</p>
                <div style="margin-top:10px; font-size:13px; color:#5f6368; background:#f1f3f4; padding:10px; border-radius:4px;">
                    <strong>üç∫ Fitness Challenge:</strong> Assumed calories based off one drink per stop: ~${pubs.length * 250} cal. 
                    Walk <strong>${((pubs.length * 250) / 60).toFixed(1)}km</strong> to burn this off.
                </div>
            `;
        }

        function displayPubList(pubs) {
            const list = document.getElementById('pub-list');
            
            // Keywords for Global Tags
            const sportsKeywords = ['sports', 'game', 'screen', 'tv', 'match', 'football', 'rugby'];
            const outdoorKeywords = ['garden', 'outdoor', 'terrace', 'patio', 'outside', 'canalside', 'sidewalk'];
            const dogFriendlyKeywords = ['dog friendly', 'dogs welcome', 'pets allowed', 'canine', 'pooch'];
            const historicKeywords = ['historic', 'victorian', 'traditional', 'heritage', '1848', 'oak paneling'];

            list.innerHTML = pubs.map((pub, i) => {
                let distInfo = '';
                if (i === 0) {
                    const d = (google.maps.geometry.spherical.computeDistanceBetween(new google.maps.LatLng(currentCenter.lat, currentCenter.lng), pub.geometry.location) / 1000).toFixed(2);
                    distInfo = `üìç <strong>Start:</strong> ${d}km from origin`;
                } else {
                    const leg = currentRouteData.routes[0].legs[i-1];
                    distInfo = `üö∂ <strong>Next Leg:</strong> ${leg.distance.text} (${leg.duration.text})`;
                }

                // Global Tag Generation
                const name = pub.name.toLowerCase();
                const summary = (pub.editorial_summary || '').toLowerCase();
                const combined = name + ' ' + summary;

                let tags = '';
                if (historicKeywords.some(kw => combined.includes(kw))) tags += `<span class="badge badge-priority">üèõÔ∏è Historic</span>`;
                if (sportsKeywords.some(kw => combined.includes(kw)) || pub.goodForWatchingSports) tags += `<span class="badge badge-sports">‚öΩ Sports</span>`;
                if (outdoorKeywords.some(kw => combined.includes(kw)) || pub.outdoorSeating) tags += `<span class="badge badge-outdoor">üå≥ Garden</span>`;
                if (dogFriendlyKeywords.some(kw => combined.includes(kw)) || pub.allowsDogs) tags += `<span class="badge badge-dogfriendly">üêï Dog Friendly</span>`;

                return `
                <div class="pub-card" onclick="openDetails(${i})">
                    <div class="pub-info">
                        <h3>${i+1}. ${pub.name}</h3>
                        <div class="pub-address">${pub.vicinity}</div>
                        <div class="pub-badges">${tags}</div>
                        <div class="route-leg-info">${distInfo}</div>
                    </div>
                    <div class="ai-summary-box">
                        <span style="font-size:10px; color:#1a73e8; font-weight:bold; display:block; margin-bottom:4px;">‚ú® AI SUMMARY</span>
                        ${pub.editorial_summary || "A local favorite with great atmosphere."}
                    </div>
                </div>`;
            }).join('');
        }

        function openDetails(idx) {
            const pub = currentPubs[idx];
            document.getElementById('modal-title').textContent = pub.name;
            const body = document.getElementById('modal-body');
            body.innerHTML = 'Loading reviews...';
            document.getElementById('pub-modal').style.display = 'block';

            placesService.getDetails({ placeId: pub.place_id, fields: ['reviews', 'rating'] }, (place) => {
                if (place.reviews) {
                    const sorted = [...place.reviews].sort((a,b) => b.rating - a.rating);
                    body.innerHTML = `
                        <div class="review-card" style="border-left:4px solid #137333;"><strong>üëç Top Positive:</strong><br>"${sorted[0].text}"</div>
                        <div class="review-card" style="border-left:4px solid #d93025;"><strong>üëé Critical:</strong><br>"${sorted[sorted.length-1].text}"</div>
                    `;
                } else {
                    body.innerHTML = 'No reviews available.';
                }
            });
        }

        window.initGoogleMapsCallback = () => { window.googleMapsLoaded = true; initializeGoogleMaps(); initializeAutocomplete(); };
        document.getElementById('modal-close').onclick = () => document.getElementById('pub-modal').style.display = 'none';
        document.getElementById('search-form').onsubmit = (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);
            searchPubs(fd.get('location'), fd.get('num-pubs'), fd.get('historic-filter'), fd.get('max-distance'), parseFloat(fd.get('min-rating')), fd.get('open-now') === 'true', fd.get('starting-radius'));
        };
    </script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-check-compat.js"></script>
    <script src="auth.js"></script>
</body>
</html>