<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pub Crawl Planner</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üç∫</text></svg>">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Google Sans', 'Roboto', Arial, sans-serif; background: #f8f9fa; min-height: 100vh; color: #202124; padding-top: 80px; }
        
        /* Header */
        .header { position: fixed; top: 0; left: 0; right: 0; background: #fff; padding: 16px 24px; border-bottom: 1px solid #dadce0; display: flex; align-items: center; justify-content: space-between; z-index: 1000; }
        .header-left { display: flex; align-items: center; gap: 16px; }
        .app-title { font-size: 18px; color: #5f6368; font-weight: 400; }

        /* Container */
        .main-container { max-width: 1000px; margin: 0 auto; padding: 20px; }

        /* Search Form */
        .search-wrapper { background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(60,64,67,.15); overflow: hidden; margin-bottom: 20px; transition: all 0.3s ease; }
        .search-form { padding: 24px; }
        .search-wrapper.collapsed .search-form { display: none; }
        .search-header { display: none; padding: 16px 24px; background: #e8f0fe; justify-content: space-between; align-items: center; cursor: pointer; }
        .search-wrapper.collapsed .search-header { display: flex; }
        
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 500; color: #3c4043; font-size: 13px; }
        .form-group input, .form-group select { width: 100%; padding: 10px 12px; border: 1px solid #dadce0; border-radius: 4px; font-size: 14px; background: white; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .search-btn { background: #1a73e8; color: white; border: none; padding: 12px; font-size: 14px; font-weight: 500; border-radius: 4px; cursor: pointer; width: 100%; transition: background 0.2s; }
        .search-btn:hover { background: #1557b0; }

        /* Map Section */
        #map-container { 
            height: 400px; 
            width: 100%; 
            background: #e8eaed; 
            border-radius: 8px; 
            margin-bottom: 20px; 
            display: none; /* Hidden until search */
            border: 1px solid #dadce0;
            overflow: hidden;
        }
        #map { height: 100%; width: 100%; }

        /* Results List */
        .results-section { display: none; }
        .route-summary { background: white; padding: 16px; border-radius: 8px; border: 1px solid #dadce0; margin-bottom: 20px; }

        /* Updated Pub Card - Side by Side Layout */
        .pub-card { 
            background: white; 
            border: 1px solid #dadce0; 
            border-radius: 8px; 
            padding: 16px; 
            margin-bottom: 16px; 
            cursor: pointer; 
            transition: box-shadow 0.2s;
            display: grid;
            grid-template-columns: 1fr 280px; /* Split: Details | Summary */
            gap: 20px;
        }
        .pub-card:hover { box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        
        /* Mobile responsive for cards */
        @media (max-width: 768px) {
            .pub-card { grid-template-columns: 1fr; } 
        }

        .pub-info h3 { color: #1a73e8; font-size: 16px; font-weight: 500; margin-bottom: 4px; }
        .pub-address { color: #5f6368; font-size: 13px; margin-bottom: 8px; }
        
        .pub-badges { display: flex; flex-wrap: wrap; gap: 6px; margin: 8px 0; }
        .badge { padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 500; }
        .badge-priority { background: #fef7e0; color: #b06000; }
        .badge-sports { background: #e6f4ea; color: #137333; }
        .badge-outdoor { background: #e8f0fe; color: #1967d2; }
        .badge-afternoontea { background: #fce8e6; color: #c5221f; }
        .badge-happyhour { background: #fef7e0; color: #b06000; }
        .badge-dogfriendly { background: #f3e8ff; color: #7e22ce; }

        .route-info { 
            margin-top: 12px; 
            padding-top: 10px; 
            border-top: 1px dashed #e8eaed; 
            font-size: 13px; 
            color: #1a73e8; 
            display: flex; 
            align-items: center; 
            gap: 6px; 
        }

        /* AI Summary Box (Right Side) */
        .ai-summary-box {
            background: #f8f9fa;
            border-left: 3px solid #1a73e8;
            padding: 12px;
            border-radius: 0 8px 8px 0;
            font-size: 13px;
            color: #3c4043;
            line-height: 1.5;
            height: fit-content;
        }
        .ai-label { font-size: 11px; color: #1a73e8; font-weight: 700; text-transform: uppercase; display: block; margin-bottom: 4px; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; }
        .modal-content { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            background: white; padding: 0; border-radius: 12px; 
            max-width: 600px; width: 95%; max-height: 85vh; overflow-y: auto; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        .modal-header { padding: 20px; border-bottom: 1px solid #e8eaed; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: white; z-index: 10;}
        .modal-body { padding: 20px; }
        .review-card { background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 12px; border: 1px solid #e8eaed; }
        .review-header { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 12px; color: #5f6368; }
        .review-text { font-size: 13px; color: #202124; line-height: 1.5; }
        
        /* Utils */
        .close { cursor: pointer; font-size: 24px; color: #5f6368; }
        .btn-link { color: #1a73e8; text-decoration: none; font-weight: 500; font-size: 14px; }
        .loading { text-align: center; padding: 40px; color: #5f6368; }
        .error { background: #fce8e6; color: #c5221f; padding: 16px; border-radius: 8px; margin-bottom: 20px; }
        
        .pac-container { z-index: 10000 !important; }
    </style>
</head>
<body>

    <div class="header">
        <div class="header-left">
            <span style="font-size: 22px; margin-right: 8px;">üç∫</span>
            <div class="app-title">Pub Crawl Planner</div>
        </div>
        <div style="display: flex; align-items: center; gap: 12px;">
            <span id="user-email" style="font-size: 13px; color: #5f6368;"></span>
            <button onclick="signOut()" style="background: white; border: 1px solid #dadce0; padding: 6px 12px; border-radius: 4px; cursor: pointer; color: #1a73e8; font-weight: 500;">Sign Out</button>
        </div>
    </div>

    <div class="main-container">
        
        <div class="search-wrapper" id="search-wrapper">
            <div class="search-header" onclick="toggleSearch()">
                <div style="display:flex; align-items:center; gap:8px;">
                    <strong>üîç Current Search:</strong>
                    <span id="search-summary-text" style="color: #5f6368; font-size: 14px;">...</span>
                </div>
                <button style="background:none; border:none; color:#1a73e8; font-weight:500; cursor:pointer;">Edit Search</button>
            </div>

            <div class="search-form">
                <form id="search-form">
                    <div class="form-group">
                        <label>Start Location</label>
                        <input type="text" name="location" id="location-input" placeholder="e.g. Covent Garden, London" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Stops</label>
                            <select name="num-pubs">
                                <option value="3">3 pubs</option>
                                <option value="5" selected>5 pubs</option>
                                <option value="8">8 pubs</option>
                                <option value="10">10 pubs</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Vibe</label>
                            <select name="historic-filter">
                                <option value="all" selected>All Types</option>
                                <option value="priority">üèõÔ∏è Historic / Traditional</option>
                                <option value="outdoor">üå≥ Outdoor / Garden</option>
                                <option value="sports">‚öΩ Sports Bar</option>
                                <option value="dogfriendly">üêï Dog Friendly</option>
                                <option value="afternoontea">ü´ñ Afternoon Tea</option>
                                <option value="happyhour">üçª Happy Hour</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Max Walk Distance (Total)</label>
                            <select name="max-distance">
                                <option value="2000">2 km (Easy)</option>
                                <option value="5000" selected>5 km (Medium)</option>
                                <option value="10000">10 km (Long)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Start Radius</label>
                            <select name="starting-radius">
                                <option value="500">0.5 km</option>
                                <option value="1000" selected>1 km</option>
                                <option value="2000">2 km</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Min Rating</label>
                            <select name="min-rating">
                                <option value="4.0" selected>4.0+</option>
                                <option value="4.5">4.5+</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Opening</label>
                            <select name="open-now">
                                <option value="false">Any time</option>
                                <option value="true">Open Now</option>
                            </select>
                        </div>
                    </div>
                    
                    <button type="submit" class="search-btn">Find Route</button>
                </form>
            </div>
        </div>

        <div id="status-area"></div>

        <div class="results-section" id="results-section">
            
            <div id="map-container">
                <div id="map"></div>
            </div>

            <div class="route-summary" id="route-summary"></div>

            <div id="pub-list"></div>
        </div>

    </div>

    <div class="modal" id="pub-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title" style="font-size: 18px; color: #202124;"></h3>
                <span class="close" id="modal-close">&times;</span>
            </div>
            <div class="modal-body" id="modal-body">
                </div>
        </div>
    </div>

    <script>
        let map, directionsService, directionsRenderer, placesService;
        let googleMapsLoaded = false;
        let currentPubs = [];
        let currentRouteData = null;

        function initializeGoogleMaps() {
            try {
                const mapOptions = {
                    zoom: 13,
                    center: { lat: 51.5074, lng: -0.1278 }, // Default London
                    mapTypeControl: false,
                    streetViewControl: false
                };
                // Initialize hidden map first to ensure services work
                map = new google.maps.Map(document.getElementById('map'), mapOptions);
                directionsService = new google.maps.DirectionsService();
                directionsRenderer = new google.maps.DirectionsRenderer({
                    map: map,
                    suppressMarkers: false,
                    polylineOptions: { strokeColor: '#1a73e8', strokeWeight: 5 }
                });
                placesService = new google.maps.places.PlacesService(map);
                
                console.log('Google Maps initialized');
            } catch (error) {
                console.error('Maps init error:', error);
            }
        }

        // --- AUTOCOMPLETE ---
        function initializeAutocomplete() {
            const input = document.getElementById('location-input');
            if(!input) return;
            const autocomplete = new google.maps.places.Autocomplete(input, { types: ['geocode', 'establishment'] });
            console.log('Autocomplete active');
        }

        // --- UI TOGGLES ---
        function toggleSearch() {
            const wrapper = document.getElementById('search-wrapper');
            wrapper.classList.toggle('collapsed');
        }

        function updateSearchSummary(location, num) {
            document.getElementById('search-summary-text').textContent = `${num} pubs near ${location}`;
            document.getElementById('search-wrapper').classList.add('collapsed');
        }

        // --- SEARCH LOGIC ---
        async function searchPubs(location, numPubs, historicFilter, maxDistance, minRating, openNow, startingRadius) {
            // UI Reset
            document.getElementById('status-area').innerHTML = '<div class="loading">Planning your route...</div>';
            document.getElementById('results-section').style.display = 'none';
            document.getElementById('map-container').style.display = 'block';

            try {
                // 1. Check Cache
                const cacheKey = `pub_cache_${btoa(location.toLowerCase() + '_' + historicFilter)}`;
                const cachedData = localStorage.getItem(cacheKey);
                let center, pubs;
                let loadedFromCache = false;

                if (cachedData) {
                    try {
                        const parsed = JSON.parse(cachedData);
                        if (Date.now() - parsed.timestamp < 86400000) { // 24hr cache
                            console.log('Loading from cache...');
                            center = parsed.center;
                            // Rehydrate Google Objects
                            pubs = parsed.pubs.map(p => ({
                                ...p,
                                geometry: { location: new google.maps.LatLng(p.geometry.location.lat, p.geometry.location.lng) }
                            }));
                            loadedFromCache = true;
                        } else { localStorage.removeItem(cacheKey); }
                    } catch(e) { localStorage.removeItem(cacheKey); }
                }

                // 2. Fetch API if needed
                if (!loadedFromCache) {
                    center = await geocodeLocation(location);
                    pubs = await findPubs(center, 1000, historicFilter);
                    
                    // Cache results
                    localStorage.setItem(cacheKey, JSON.stringify({
                        center: center,
                        pubs: pubs,
                        timestamp: Date.now()
                    }));
                }

                // 3. Filter & Sort
                const filtered = filterPubs(pubs, historicFilter, minRating, openNow);
                if (filtered.length === 0) throw new Error("No pubs found matching criteria.");

                // Sort by distance from Center
                const sortedByDist = filtered.map(p => ({
                    ...p,
                    distance: google.maps.geometry.spherical.computeDistanceBetween(
                        new google.maps.LatLng(center.lat, center.lng),
                        p.geometry.location
                    )
                })).sort((a,b) => a.distance - b.distance);

                // 4. Select Route
                const startR = parseInt(startingRadius);
                const firstPub = sortedByDist.find(p => p.distance <= startR);
                if (!firstPub) throw new Error(`No pubs found within ${startR}m of start.`);

                const pool = sortedByDist.filter(p => p.distance <= maxDistance);
                // Ensure firstPub is at start, removing duplicates
                const routeCandidates = [firstPub, ...pool.filter(p => p.place_id !== firstPub.place_id)];

                const targetCount = parseInt(numPubs);
                // Optimize: Take nearest neighbors
                const finalRoute = optimizeRoute(routeCandidates.slice(0, Math.min(routeCandidates.length, targetCount * 2)), center).slice(0, targetCount);

                // 5. Directions
                if(finalRoute.length < 2) throw new Error("Need at least 2 pubs for a route.");
                
                const directions = await calculateDirections(finalRoute);
                if(!directions) throw new Error("Could not calculate walking path.");

                currentRouteData = directions;
                currentPubs = finalRoute;

                // 6. Display
                updateSearchSummary(location, finalRoute.length);
                document.getElementById('status-area').innerHTML = ''; // Clear loading
                document.getElementById('results-section').style.display = 'block';
                
                // Trigger Map Resize now that it is visible
                google.maps.event.trigger(map, 'resize');
                
                displayResults(finalRoute);

            } catch (e) {
                console.error(e);
                document.getElementById('status-area').innerHTML = `<div class="error">Error: ${e.message}</div>`;
            }
        }

        // --- HELPERS ---
        async function geocodeLocation(address) {
            const user = firebase.auth().currentUser;
            const token = await user.getIdToken();
            const res = await fetch('https://pub-crawler-backend.vercel.app/api/geocode', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ address })
            });
            const data = await res.json();
            if(data.status !== 'OK') throw new Error('Location not found');
            return data.results[0].geometry.location;
        }

        async function findPubs(center, radius, type) {
            const user = firebase.auth().currentUser;
            const token = await user.getIdToken();
            
            // Map keywords
            let keyword = 'pub';
            if(type === 'sports') keyword = 'sports bar';
            if(type === 'afternoontea') keyword = 'tea room';
            if(type === 'priority') keyword = 'historic pub';
            if(type === 'outdoor') keyword = 'beer garden';

            const res = await fetch('https://pub-crawler-backend.vercel.app/api/search-places', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({
                    location: `${center.lat},${center.lng}`,
                    radius: 2000, // Search radius
                    keyword: keyword,
                    type: 'bar'
                })
            });
            const data = await res.json();
            return (data.places || []).map(p => ({
                place_id: p.id,
                name: p.displayName?.text,
                vicinity: p.formattedAddress,
                rating: p.rating,
                user_ratings_total: p.userRatingCount,
                geometry: { location: new google.maps.LatLng(p.location.latitude, p.location.longitude) },
                ai_summary: '', // Backend doesn't always send this, placeholder
                editorial_summary: p.editorialSummary?.text,
                types: p.types || []
            }));
        }

        function filterPubs(pubs, type, minRating, openNow) {
            // Basic client-side filtering
            return pubs.filter(p => {
                if(p.rating < minRating) return false;
                // Add more logic here if backend data supports 'open_now' check
                return true; 
            });
        }

        function optimizeRoute(pubs, start) {
            // Nearest Neighbor greedy sort
            if(!pubs.length) return [];
            let ordered = [pubs[0]];
            let remaining = pubs.slice(1);
            let current = pubs[0];

            while(remaining.length > 0) {
                let nearestIdx = 0;
                let minD = Infinity;
                remaining.forEach((p, i) => {
                    const d = google.maps.geometry.spherical.computeDistanceBetween(current.geometry.location, p.geometry.location);
                    if(d < minD) { minD = d; nearestIdx = i; }
                });
                current = remaining.splice(nearestIdx, 1)[0];
                ordered.push(current);
            }
            return ordered;
        }

        function calculateDirections(pubs) {
            return new Promise(resolve => {
                const waypoints = pubs.slice(1, -1).map(p => ({ location: p.geometry.location, stopover: true }));
                directionsService.route({
                    origin: pubs[0].geometry.location,
                    destination: pubs[pubs.length-1].geometry.location,
                    waypoints: waypoints,
                    travelMode: 'WALKING'
                }, (result, status) => {
                    if(status === 'OK') resolve(result);
                    else resolve(null);
                });
            });
        }

        // --- DISPLAY ---
        function displayResults(pubs) {
            // Render Map
            directionsRenderer.setDirections(currentRouteData);
            
            // Render Summary
            const legTotal = currentRouteData.routes[0].legs.reduce((acc, leg) => acc + leg.distance.value, 0);
            const km = (legTotal / 1000).toFixed(1);
            
            // Calorie Math
            const cal = pubs.length * 250;
            const walkCal = km * 60;
            
            document.getElementById('route-summary').innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <h3 style="margin-bottom:4px;">Route Overview</h3>
                        <div style="font-size:14px; color:#5f6368;">
                            üìç ${pubs.length} Stops &nbsp;‚Ä¢&nbsp; üë£ ${km} km Walking &nbsp;‚Ä¢&nbsp; üî• Burn ${Math.round(walkCal)} of ${cal} drink cals
                        </div>
                    </div>
                </div>
            `;

            // Render List
            const list = document.getElementById('pub-list');
            list.innerHTML = pubs.map((pub, i) => {
                // Distance Text
                let distText = '';
                if(i === 0) {
                    // Dist from search center
                    distText = `üìç Start Point`;
                } else {
                    // Dist from previous pub (Leg i-1)
                    const leg = currentRouteData.routes[0].legs[i-1];
                    distText = `üö∂ Walk <strong>${leg.distance.text}</strong> (${leg.duration.text})`; 
                }

                // AI Summary / Description
                const summary = pub.editorial_summary || "No description available.";
                
                // Badges (Simple logic based on types/summary)
                let badges = '';
                const txt = (pub.name + summary).toLowerCase();
                if(txt.includes('historic') || txt.includes('old')) badges += `<span class="badge badge-priority">Historic</span>`;
                if(txt.includes('garden') || txt.includes('outdoor')) badges += `<span class="badge badge-outdoor">Garden</span>`;

                return `
                <div class="pub-card" onclick="openDetails(${i})">
                    <div class="pub-info">
                        <h3>${i+1}. ${pub.name}</h3>
                        <div class="pub-address">${pub.vicinity}</div>
                        <div class="pub-badges">${badges}</div>
                        
                        <div style="display:flex; align-items:center; gap:4px; font-size:13px; margin-top:6px;">
                            <span style="color:#fbbc04;">‚òÖ</span> 
                            <b>${pub.rating}</b> <span style="color:#5f6368;">(${pub.user_ratings_total})</span>
                        </div>

                        <div class="route-info">${distText}</div>
                    </div>
                    
                    <div class="ai-summary-box">
                        <span class="ai-label">‚ú® AI Summary</span>
                        ${summary.substring(0, 120)}${summary.length>120?'...':''}
                    </div>
                </div>`;
            }).join('');
        }

        // --- MODAL & REVIEWS ---
        function openDetails(index) {
            const pub = currentPubs[index];
            const modal = document.getElementById('pub-modal');
            document.getElementById('modal-title').textContent = pub.name;
            const body = document.getElementById('modal-body');
            
            body.innerHTML = '<div class="loading">Fetching best & worst reviews...</div>';
            modal.style.display = 'block';

            // Fetch Reviews using Client-Side Places Service
            const request = {
                placeId: pub.place_id,
                fields: ['reviews', 'formatted_phone_number', 'website', 'opening_hours']
            };

            placesService.getDetails(request, (place, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                    renderModalContent(pub, place);
                } else {
                    body.innerHTML = `<div class="error">Could not fetch details. (Status: ${status})</div>`;
                }
            });
        }

        function renderModalContent(basicPub, detailedPlace) {
            const body = document.getElementById('modal-body');
            let reviewsHtml = '';

            if (detailedPlace.reviews && detailedPlace.reviews.length > 0) {
                // Sort by rating to find Best and Worst
                const sorted = [...detailedPlace.reviews].sort((a,b) => a.rating - b.rating);
                
                // Worst: Lowest rating (preferably with text)
                const worst = sorted.find(r => r.text.length > 10) || sorted[0];
                // Best: Highest rating
                const best = sorted.reverse().find(r => r.text.length > 10) || sorted[0];

                reviewsHtml = `
                    <h4 style="margin: 16px 0 8px;">Top Reviews</h4>
                    
                    <div class="review-card" style="border-left: 4px solid #137333;">
                        <div class="review-header">
                            <strong>üëç Best Review</strong>
                            <span>${best.relative_time_description}</span>
                        </div>
                        <div style="margin-bottom:4px;">${'‚òÖ'.repeat(best.rating)}</div>
                        <div class="review-text">"${best.text}"</div>
                    </div>

                    <div class="review-card" style="border-left: 4px solid #d93025;">
                        <div class="review-header">
                            <strong>üëé Critical Review</strong>
                            <span>${worst.relative_time_description}</span>
                        </div>
                        <div style="margin-bottom:4px;">${'‚òÖ'.repeat(worst.rating)} <span style="color:#dadce0;">${'‚òÖ'.repeat(5-worst.rating)}</span></div>
                        <div class="review-text">"${worst.text}"</div>
                    </div>
                `;
            } else {
                reviewsHtml = '<p style="color:#5f6368; font-style:italic;">No reviews available for this venue.</p>';
            }

            const openStatus = detailedPlace.opening_hours ? 
                (detailedPlace.opening_hours.isOpen() ? '<span style="color:#137333; font-weight:bold;">Open Now</span>' : '<span style="color:#d93025; font-weight:bold;">Closed</span>') 
                : '';

            body.innerHTML = `
                <div style="margin-bottom: 16px;">
                    <div style="font-size:14px; margin-bottom:8px;">${openStatus}</div>
                    <div style="font-size:14px; color:#5f6368;">${basicPub.vicinity}</div>
                    ${detailedPlace.formatted_phone_number ? `<div style="font-size:14px; color:#1a73e8;">${detailedPlace.formatted_phone_number}</div>` : ''}
                    ${detailedPlace.website ? `<a href="${detailedPlace.website}" target="_blank" class="btn-link" style="display:inline-block; margin-top:8px;">Visit Website &rarr;</a>` : ''}
                </div>
                <hr style="border:0; border-top:1px solid #e8eaed;">
                ${reviewsHtml}
                <div style="margin-top:20px; text-align:center;">
                    <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(basicPub.name)}&query_place_id=${basicPub.place_id}" target="_blank" 
                       style="background:#1a73e8; color:white; padding:10px 20px; text-decoration:none; border-radius:4px; font-weight:500;">
                       View on Google Maps App
                    </a>
                </div>
            `;
        }

        // --- INIT ---
        window.initGoogleMapsCallback = function() {
            console.log('Maps Loaded Callback');
            window.googleMapsLoaded = true;
            initializeGoogleMaps();
            initializeAutocomplete();
        };

        // Listeners
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('search-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const fd = new FormData(e.target);
                searchPubs(
                    fd.get('location'), 
                    fd.get('num-pubs'), 
                    fd.get('historic-filter'),
                    fd.get('max-distance'),
                    parseFloat(fd.get('min-rating')),
                    fd.get('open-now') === 'true',
                    fd.get('starting-radius')
                );
            });
            document.getElementById('modal-close').onclick = () => document.getElementById('pub-modal').style.display = 'none';
            window.onclick = (e) => { if(e.target == document.getElementById('pub-modal')) document.getElementById('pub-modal').style.display = 'none'; };
        });

    </script>

    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-check-compat.js"></script>
    <script src="auth.js"></script>

</body>
</html>